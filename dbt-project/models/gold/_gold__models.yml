version: 2

models:
  - name: dim_customers
    description: "Customer dimension table with order metrics and tier classification"
    config:
      contract:
        enforced: true   # dbt generates CREATE TABLE (col type...) AS SELECT — no CAST added to SQL
    columns:
      - name: customer_id
        description: "Primary key for customers"
        data_type: integer
        data_tests:
          - not_null
          - unique
      - name: first_name
        description: "Customer first name"
        data_type: varchar
      - name: last_name
        description: "Customer last name"
        data_type: varchar
      - name: email
        description: "Customer email address"
        data_type: varchar
        data_tests:
          - dbt_expectations.expect_column_values_to_match_regex:
              regex: '^[^@\s]+@[^@\s]+\.[^@\s]+$'
              # Basic email format: local@domain.tld
      - name: phone
        description: "Customer phone number"
        data_type: varchar
      - name: address
        description: "Street address"
        data_type: varchar
      - name: city
        description: "City"
        data_type: varchar
      - name: state_code
        description: "State or province code"
        data_type: varchar
      - name: postal_code
        description: "Postal / ZIP code"
        data_type: varchar
      - name: country_code
        description: "ISO 2-letter country code"
        data_type: varchar
      - name: created_at
        description: "Record creation timestamp"
        data_type: timestamp_ntz
      - name: updated_at
        description: "Record last-updated timestamp"
        data_type: timestamp_ntz
      - name: total_orders
        description: "Total number of orders placed by customer"
        data_type: integer
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              # A customer can exist with 0 orders (new, no purchases yet)
      - name: total_spent
        description: "Total amount spent by customer across all orders"
        data_type: float
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
      - name: first_order_date
        description: "Date of first order (null if no orders)"
        data_type: date
      - name: last_order_date
        description: "Date of most recent order (null if no orders)"
        data_type: date
      - name: customer_tier
        description: "Customer tier based on spending: VIP / Premium / Regular / New"
        data_type: varchar
        data_tests:
          - not_null
          - accepted_values:
              values: ['VIP', 'Premium', 'Regular', 'New']

  - name: dim_products
    description: "Product dimension table with sales metrics and performance classification"
    config:
      contract:
        enforced: true
    columns:
      - name: product_id
        description: "Primary key for products"
        data_type: integer
        data_tests:
          - not_null
          - unique
      - name: product_name
        description: "Product display name"
        data_type: varchar
      - name: category
        description: "Top-level product category"
        data_type: varchar
      - name: subcategory
        description: "Product subcategory"
        data_type: varchar
      - name: brand
        description: "Product brand"
        data_type: varchar
      - name: price
        description: "List price"
        data_type: float
        data_tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              strictly: true   # price must be > 0
      - name: cost
        description: "Unit cost"
        data_type: float
        data_tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
      - name: description
        description: "Product description"
        data_type: varchar
      - name: is_active
        description: "Whether the product is active in the catalog"
        data_type: boolean
      - name: created_at
        description: "Record creation timestamp"
        data_type: timestamp_ntz
      - name: updated_at
        description: "Record last-updated timestamp"
        data_type: timestamp_ntz
      - name: total_orders
        description: "Number of order line items containing this product"
        data_type: integer
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
      - name: total_quantity_sold
        description: "Total units sold across all orders"
        data_type: integer
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
      - name: total_revenue
        description: "Total revenue generated by this product"
        data_type: float
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
      - name: avg_selling_price
        description: "Average unit price at which the product was sold"
        data_type: float
        data_tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
      - name: profit_margin
        description: "Per-unit profit margin (price - cost); can be negative"
        data_type: float
        data_tests:
          - not_null
      - name: performance_category
        description: "Product performance tier based on total revenue"
        data_type: varchar
        data_tests:
          - not_null
          - accepted_values:
              values: ['High Performance', 'Medium Performance', 'Low Performance', 'No Sales']

  - name: fct_orders
    description: "Fact table for order line items. Grain: one row per order_item_id. Join to dims via FKs."
    config:
      contract:
        enforced: true
    columns:
      - name: order_item_id
        description: "Primary key (grain: one row per order line item)"
        data_type: integer
        data_tests:
          - not_null
          - unique
      - name: order_id
        description: "Order identifier — one order can have many line items"
        data_type: integer
        data_tests:
          - not_null
      - name: customer_id
        description: "FK to dim_customers"
        data_type: integer
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_customers')
              field: customer_id
      - name: product_id
        description: "FK to dim_products"
        data_type: integer
        data_tests:
          - not_null
          - relationships:
              to: ref('dim_products')
              field: product_id
      - name: order_date
        description: "Date the order was placed"
        data_type: date
        data_tests:
          - not_null
      - name: status
        description: "Order status"
        data_type: varchar
        data_tests:
          - not_null
      - name: payment_method
        description: "Payment method used"
        data_type: varchar
      - name: quantity
        description: "Quantity of product ordered"
        data_type: integer
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 1   # can't order 0 of something
      - name: unit_price
        description: "Price per unit at time of sale"
        data_type: float
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              strictly: true
      - name: total_price
        description: "Line total (quantity * unit_price - discount)"
        data_type: float
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
      - name: discount_amount
        description: "Discount applied to this line item"
        data_type: float
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
      - name: order_total
        description: "Full order total (denormalized from orders)"
        data_type: float
        data_tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
      - name: created_at
        description: "Record creation timestamp"
        data_type: timestamp_ntz
        data_tests:
          - not_null
