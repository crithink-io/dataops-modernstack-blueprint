name: DDL - Deploy on Merge

on:
  push:
    branches: [main, uat, dev]
    paths:
      - 'ddls/**'
      - '.github/workflows/ddl_cd.yml'

concurrency:
  group: ddl-cd-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  ddl_deploy:
    runs-on: ubuntu-latest

    env:
      SNOWFLAKE_ACCOUNT:   ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_USER:      ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_PASSWORD:  ${{ secrets.SNOWFLAKE_PASSWORD }}
      SNOWFLAKE_ROLE:      ${{ secrets.SNOWFLAKE_ROLE }}
      SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install SnowSQL
        run: |
          curl -o snowsql.bash https://sfc-repo.snowflakecomputing.com/snowsql/bootstrap/1.3/linux_x86_64/snowsql-1.3.2-linux_x86_64.bash
          SNOWSQL_DEST=~/bin SNOWSQL_LOGIN_SHELL=~/.profile bash snowsql.bash
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Determine target environment
        run: |
          BRANCH="${{ github.ref_name }}"
          case "$BRANCH" in
            main) echo "TARGET_ENV=prod" >> $GITHUB_ENV ;;
            uat)  echo "TARGET_ENV=uat"  >> $GITHUB_ENV ;;
            dev)  echo "TARGET_ENV=dev"  >> $GITHUB_ENV ;;
          esac
          echo "Deploying DDLs for environment: $BRANCH"

      - name: Detect changed DDL files
        id: changed
        run: |
          CHANGED=$(git diff --name-only --diff-filter=ACMR HEAD~1 -- ddls/ | grep '\.sql$' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ── Deploy in dependency order ─────────────────────────────
      # Priority: databases → warehouses → schemas → file_formats →
      #           stages → tables → views → functions → procedures
      - name: Deploy DDLs to Snowflake
        if: steps.changed.outputs.files != ''
        run: |
          CHANGED_FILES="${{ steps.changed.outputs.files }}"

          # Define deployment order by path pattern
          PRIORITY_PATTERNS=(
            "_account/databases/"
            "_account/warehouses/"
            "_schemas/"
            "file_formats/"
            "stages/"
            "tables/"
            "views/"
            "functions/"
            "procedures/"
          )

          DEPLOYED=0
          FAILED=0

          for pattern in "${PRIORITY_PATTERNS[@]}"; do
            # Find changed files matching this priority level
            MATCHING=$(echo "$CHANGED_FILES" | grep "$pattern" || true)
            [ -z "$MATCHING" ] && continue

            echo ""
            echo "=========================================="
            echo "Deploying: $pattern"
            echo "=========================================="

            while IFS= read -r file; do
              [ -z "$file" ] && continue
              echo "--- Executing: $file"
              if snowsql \
                --accountname "$SNOWFLAKE_ACCOUNT" \
                --username "$SNOWFLAKE_USER" \
                --filename "$file" \
                --option exit_on_error=true \
                --option friendly=false \
                --option timing=false 2>&1; then
                echo "OK: $file"
                DEPLOYED=$((DEPLOYED + 1))
              else
                echo "FAILED: $file"
                FAILED=$((FAILED + 1))
              fi
            done <<< "$MATCHING"
          done

          echo ""
          echo "=========================================="
          echo "Deployment summary: $DEPLOYED succeeded, $FAILED failed"
          echo "=========================================="

          if [ "$FAILED" -gt 0 ]; then
            exit 1
          fi
